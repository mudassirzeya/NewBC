{% extends "base.html" %} 
{% load static %} 
{% load mystery_extras %}
{% block breadcrumb %} 
<h5 class="text-primary mb-0" style="font-weight: bold; white-space: nowrap;"><a class="text-primary mb-0" href="javascript:history.back()">Mystery Shopping</a> <i class="fas fa-angle-double-right"></i> {{mystery_shopping.center}} ({{mystery_shopping.month_of_audit}}) <a class="text-info" data-toggle="modal" data-target="#mystery_info_modal"><i class="fas fa-eye"></i></a>
</h5>
{% endblock breadcrumb %} 
{% block content %} 
{% for message in messages %} 
<p class="text-danger text-center" id="messages">{{message}}</p> 
{% endfor %} 
<input type="hidden" name="" id="exit_check">
<div class="modal fade" id="mystery_info_modal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Mystery Shopping Information</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="row">
                    <!-- Column -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card">
                            <div class="d-flex flex-row">
                                <div class="p-2 bg-info">
                                    <h3 class="text-white box mb-0"><i class="ti-themify-favicon-alt"></i></h3>
                                </div>
                                <div class="p-2">
                                    <h3 class="text-info mb-0">{{mystery_shopping.center}}</h3>
                                    <span class="text-muted">{{mystery_shopping.date}},<br> {{mystery_shopping.start_time}} to {{mystery_shopping.end_time}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card">
                            <div class="d-flex flex-row">
                                <div class="p-2 bg-success">
                                    <h3 class="text-white box mb-0"><i class="ti-signal"></i></h3>
                                </div>
                                <div class="p-2">
                                    <h3 class="text-success mb-0">{{mystery_shopping.shopper_name}} ({{mystery_shopping.gender}})</h3>
                                    <span class="text-muted"> {{mystery_shopping.email}} <br> {{mystery_shopping.mobile}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card">
                            <div class="d-flex flex-row">
                                <div class="p-2 bg-inverse">
                                    <h3 class="text-white box mb-0"><i class="ti-timer"></i></h3>
                                </div>
                                <div class="p-2">
                                    <h3 class="mb-0">{{mystery_shopping.invoice_number}}</h3>
                                    <span class="text-muted">Cost: {{mystery_shopping.cost_of_service}} | Mode: {{mystery_shopping.payment_mode}}</span> <br>
                                    <span>Cash: {{mystery_shopping.paid_in_cash}} | Redeemed {{mystery_shopping.amount_redeemed}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-lg-3 col-md-6">
                        <div class="card">
                            <div class="d-flex flex-row">
                                <div class="p-2 bg-cyan">
                                    <h3 class="text-white box mb-0"><i class="ti-server"></i></h3>
                                </div>
                                <div class="p-2">
                                    <span class="text-muted">Added By: {{mystery_shopping.added_by}}</span>
                                    <br><br>
                                    <span class="text-muted">Added On: {{mystery_shopping.added_on}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="tag-mysteryprofile_tab" data-toggle="tab" href="#mysteryprofile_tab" role="tab" aria-controls="home" aria-selected="true" onclick="return saveTabSelect(this)">Details</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="tag-serviceagent_tab" data-toggle="tab" href="#serviceagent_tab" role="tab" aria-controls="profile" aria-selected="false" onclick="return saveTabSelect(this)">
                {{mystery_shopping.service_availed_1}}</a>
        </li>
        {% if mystery_shopping.service_availed_2 %}
        <li class="nav-item">
            <a class="nav-link" id="tag-serviceagent_tab_2" data-toggle="tab" href="#serviceagent_tab_2" role="tab" aria-controls="profile" aria-selected="false" onclick="return saveTabSelect(this)">
                {{mystery_shopping.service_availed_2}}</a>
        </li>
        {% endif %}
        {% if mystery_shopping.service_availed_3 %}
        <li class="nav-item">
            <a class="nav-link" id="tag-serviceagent_tab_3" data-toggle="tab" href="#serviceagent_tab_3" role="tab" aria-controls="profile" aria-selected="false" onclick="return saveTabSelect(this)">
                {{mystery_shopping.service_availed_3}}</a>
        </li>
        {% endif %}
        <li class="nav-item">
            <a class="nav-link" id="tag-mysteryimage_tab" data-toggle="tab" href="#mysteryimage_tab" role="tab" aria-controls="profile" aria-selected="false" onclick="return saveTabSelect(this)">Files</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="mysteryprofile_tab" role="tabpanel" aria-labelledby="home-tab"> 
            {% include 'mystery_shopping/mystery_shopping_profile_tabs/profile_tab.html' %} </div>
        <div class="tab-pane fade" id="serviceagent_tab" role="tabpanel" aria-labelledby="agent-tab"> 
            {% include 'mystery_shopping/mystery_shopping_profile_tabs/service_agent_tab_1.html' %} </div>
        <div class="tab-pane fade" id="serviceagent_tab_2" role="tabpanel" aria-labelledby="agent-tab-2"> 
            {% include 'mystery_shopping/mystery_shopping_profile_tabs/service_agent_tab_2.html' %} </div>
        <div class="tab-pane fade" id="serviceagent_tab_3" role="tabpanel" aria-labelledby="agent-tab-3"> 
            {% include 'mystery_shopping/mystery_shopping_profile_tabs/service_agent_tab_3.html' %} </div>
        <div class="tab-pane fade" id="mysteryimage_tab" role="tabpanel" aria-labelledby="profile-tab"> 
            {% include 'mystery_shopping/mystery_shopping_profile_tabs/images_list_tab.html' %} </div>
    </div>
</div>


<script>
    // const client_id = "{{client.id}}";

    // function redirectToDataUploader() {
    //     $('cover-spin').show();
    //     window.location.href = `/data-uploader/?client=${client_id}`
    // }


    // TODO add to session
    function saveTabSelect(item) {
        // var selectedTag = JSON.parse(sessionStorage.getItem('client_tag')) || null;
        // sessionStorage.setItem('client_tag', JSON.stringify(storedProductList));
        // var selectedTag = sessionStorage.getItem('client_tag') || null;
        // sessionStorage.setItem('client_tag', storedProductList);
        var prevSelectedTag = localStorage.getItem("curr_mysteryprofile_tag");
        // console.log(`prevSelectedTag: `, prevSelectedTag);
        if (item.id == prevSelectedTag) {
            return;
        }
        if (prevSelectedTag) {
            var element = document.getElementById(prevSelectedTag);
            element.classList.remove("active");

            var tabPaneId = `${prevSelectedTag.split("-")[1]}`;
            // console.log(`tabPanId: `, tabPanId);
            var tabePaneElement = document.getElementById(tabPaneId);
            tabePaneElement.classList.remove('active');
        }
        localStorage.setItem("curr_mysteryprofile_tag", item.id);
        // console.log(`cur tag id: `, item.id)
        return true;
    }

    function retrieveSelected() {
        var curTag = localStorage.getItem("curr_mysteryprofile_tag");
        // console.log(`curTag: `, curTag);
        if (curTag) {
            var curElement = document.getElementById(`${curTag}`);
            if (curElement) {
                // revome active from first pill and tab in case there's any prev tag in local storage
                var dataTag = document.getElementById('tag-mysteryprofile_tab');
                dataTag.classList.remove("active");
                var dataTabPaneElement = document.getElementById('mysteryprofile_tab');
                dataTabPaneElement.classList.remove('active');

                // Add active to tab
                curElement.classList.add("active");
                var curPaneId = `${curTag.split('-')[1]}`;
                var curPaneElement = document.getElementById(curPaneId);
                curPaneElement.classList.add('show');
                curPaneElement.classList.add('active');

                // const tab = $(curElement).data('tab_selected');
                // window.location.href = `/clients/${client_id}/?tab=${tab}`;
            } else {
                // Else set in local storage the current active tab
                localStorage.setItem("curr_mysteryprofile_tag", 'tag-mysteryprofile_tab');
            }

        } else {
            // Else set in local storage the current active tab
            localStorage.setItem("curr_mysteryprofile_tag", 'tag-mysteryprofile_tab');
        }
    }
    retrieveSelected();

    window.onbeforeunload = function () {
            var value = document.getElementById('exit_check').value;
            if (value == 'wait') {
                return 'Some data is not saved. Are you sure, you want to exit ?';
            }
    };

    function update_exit_check(){
        var exit_check = document.getElementById('exit_check');
        exit_check.value = "wait";
        var mytab = document.getElementById('myTab');
        mytab.classList.add('d-none');
        var side_navbar = document.getElementById('side_bar_id');
        side_navbar.classList.add('d-none');
    }
    var all_users = {{ all_therapy_ext_emp|safe }}

    function get_user_list_and_make_userresposible_dropdown(t, if_new) {
            var ms_id = t
            // var ms_id = ms_id_split.pop();
            $('#cover-spin').show(0);
            fetch("/sent_selected_user_list_to_frontend/", {
                method: "POST",
                body: JSON.stringify({
                    'audit_id': ms_id,
                    'audit_name': 'Mystery Shopping',
                }),
                // Adding headers to the request
                headers: {
                    "Content-type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
            })
                .then((response) => {
                    // console.log(response);
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    return response.json();
                })
                .then((data) => {
                    // console.log("Success: ", data);
                    var selected_user = data.user_json;
                    var selected_compliance = data.selected_compliance;
                    var remark_text = data.remark;
                    // var user_list = [7,8,9,10]
                    if (data.msg == 'success') {
                        $('#cover-spin').hide(0);
                        var dropDownId = 'person_responsible_dropdown__'+ms_id;
                        // console.log('all_user', all_users, dropDownId, user_list)
                        // create_dropdown(dropDownId, dropDownId, all_users, selected_user, 'single');
                        if(if_new == 'Old'){
                            create_dropdown(`person_responsible_dropdown__${ms_id}`, `person_responsible_dropdown__${ms_id}`, all_users, selected_user, 'single')
                            create_dropdown(`compliance_dropdown__${ms_id}`, `compliance_dropdown__${ms_id}`, data.all_compliance_list, selected_compliance, 'single')
                            document.getElementById('auditor_remark__' + ms_id).innerHTML = `<textarea class="form-control" id="remark__${ms_id}" rows="3">${remark_text}</textarea><span class="text-danger" id="remark_error__${ms_id}"></span>`;
                            var EditBtn = document.getElementById("edit_person_responsible_btn__" + ms_id);
                            var editiconElement = EditBtn.querySelector("i");
                            editiconElement.classList.remove("fa-edit");
                            editiconElement.classList.add("fa-check");
                            EditBtn.onclick = function () {
                                save_user_responsible_and_remove_userresposible_dropdown(this, 'Old');
                            }
                        }else{
                            create_dropdown(`person_responsible_dropdown__${if_new}`, `person_responsible_dropdown__${if_new}`, all_users, selected_user, 'single')
                            create_dropdown(`compliance_dropdown__${if_new}`, `compliance_dropdown__${if_new}`, data.all_compliance_list, selected_compliance, 'single')
                            document.getElementById('auditor_remark__' + if_new).innerHTML = `<textarea class="form-control" id="remark__${if_new}" rows="3">${remark_text}</textarea><span class="text-danger" id="remark_error__${if_new}"></span>`;
                            var EditBtn = document.getElementById("edit_person_responsible_btn__" + if_new);
                            EditBtn.name = "edit_person_responsible_btn__"+ms_id;
                            var editiconElement = EditBtn.querySelector("i");
                            editiconElement.classList.remove("fa-edit");
                            editiconElement.classList.add("fa-check");
                            EditBtn.onclick = function () {
                                save_user_responsible_and_remove_userresposible_dropdown(this, 'Old-New');
                            }
                        }
                    }
                    else {
                        $('#cover-spin').hide(0);
                        alert('Something went wrong, Please try again after refreshing the page')
                    }
                });
        }
    
    function save_user_responsible_and_remove_userresposible_dropdown(t, status) {
        var ms_id = t.id.split('__')[1];
        console.log("id:", ms_id, status)
        var checklist_id = 0;
        if(status == 'New'){
            checklist_id = t.name.split('__')[1];
        }
        var selected_user = document.getElementById('person_responsible_dropdown__'+ms_id).value;
        var selected_compliance = document.getElementById('compliance_dropdown__'+ms_id).value;
        var get_remark = document.getElementById('remark__'+ms_id).value;
        var compliance_list = ["Partially followed", "Couldn't follow", "Not aware", "Not followed", "Like", "Partially Like", "Dislike", "1", "2", "3", "4", "5", "Yes", "No", "May be", "Couldnt follow"];
        var total_error = 0;
        if (compliance_list.indexOf(selected_compliance) !== -1) {
            if (get_remark.length > 1) {
                document.getElementById('remark_error__'+ms_id).innerHTML = '';
                total_error = 0;
            }
            else {
                document.getElementById('remark_error__'+ms_id).innerHTML = 'Please write the Remarks';
                total_error = total_error + 1;
            }
        } else {
            total_error = 0;
        }
        if (selected_user.length > 0 && selected_compliance.length){
            if(total_error == 0){
                $('#cover-spin').show(0);
                if (status == 'Old-New') {
                    ms_id = t.name.split('__')[1];
                }
                fetch("/save_selected_user_responsible/", {
                    method: "POST",
                    body: JSON.stringify({
                        'audit_id': ms_id,
                        'audit_name': 'Mystery Shopping',
                        'selected_user': selected_user,
                        'selected_compliance': selected_compliance,
                        'status':status,
                        'checklist_id': checklist_id,
                        'get_remark': get_remark
                    }),
                    // Adding headers to the request
                    headers: {
                        "Content-type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                })
                    .then((response) => {
                        // console.log(response);
                        if (response.redirected) {
                            window.location.href = response.url;
                            return;
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // console.log("Success: ", data);
                        var selected_user = data.user_json;
                        var selected_compliance = data.compliance;
                        var remark_text = data.get_remark;
                        // var user_list = [7,8,9,10]
                        if (data.msg == 'success') {
                            if (status == 'Old-New') {
                                ms_id = t.id.split('__')[1];
                            }
                            $('#cover-spin').hide(0);
                            var delBtn = document.getElementById("remove_person_responsible_row__" + ms_id);
                            var saveBtn = document.getElementById("edit_person_responsible_btn__" + ms_id);
                            try {
                                $('#person_responsible_dropdown__' + ms_id).multiselect('destroy');
                                $('#compliance_dropdown__' + ms_id).multiselect('destroy');
                            } catch (e) { }
                            var userRespdropdownId = document.getElementById('person_responsible_dropdown__'+ms_id);
                            var compliancepdropdownId = document.getElementById('compliance_dropdown__' + ms_id);
                            var remarkText = document.getElementById('auditor_remark__' + ms_id);
                            // delBtn.classList.remove("d-none");
                            
                            delBtn.onclick = function(){
                                delete_user_response(this, data.user_resp_query_id);   
                            }
                            
                            var editiconElement = saveBtn.querySelector("i");
                            editiconElement.classList.remove("fa-trash-check");
                            editiconElement.classList.add("fa-edit");
                            saveBtn.onclick = function(){
                                get_user_list_and_make_userresposible_dropdown(data.user_resp_query_id, ms_id);
                            }
                           
                            var html_1 = `<span id="person_responsible_dropdown__${ms_id}">${selected_user.name}</span>`;
                            userRespdropdownId.outerHTML = html_1;
    
                            var html_2 = `<span id="compliance_dropdown__${ms_id}">${selected_compliance}</span>`;
                            compliancepdropdownId.outerHTML = html_2;
    
                            var html_3 = `<span id="auditor_remark__${ms_id}">${remark_text}</span>`;
                            remarkText.outerHTML = html_3;
                        
                        }
                        else {
                            $('#cover-spin').hide(0);
                            alert('Something went wrong, Please try again after refreshing the page')
                        }
                    });
            }

        }else{
            alert("Kindly Complete Both 'Input Person Responsible' and 'Compliance' Fields")
        }
    }

    function delete_user_response(t, user_response_id) {
        $('#cover-spin').show(0);
        fetch("/delete_user_response/", {
            method: "POST",
            body: JSON.stringify({
                'checklist_id': user_response_id,
                'audit_name': 'Mystery Shopping',
            }),
            // Adding headers to the request
            headers: {
                "Content-type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
        })
            .then((response) => {
                // console.log(response);
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                return response.json();
            })
            .then((data) => {
                // console.log("Success: ", data);
                if (data.msg == 'success') {
                    $('#cover-spin').hide(0);
                    var row = t.closest("tr"); // Get the parent <tr> element
                    if (row) {
                        row.remove(); // Remove the entire row
                    }
                }
                else {
                    $('#cover-spin').hide(0);
                    alert('Something went wrong, Please try again after refreshing the page')
                }
            });

    }

    function remove_person_responsible_row(t){
        var row = t.closest("tr"); // Get the parent <tr> element
        if (row) {
            row.remove(); // Remove the entire row
        }
    }

    function get_selected_user_responsible(t){

    }

</script>

{% endblock %}