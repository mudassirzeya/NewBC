{% extends "base.html" %}

{% block breadcrumb %} 
<h5 class="text-primary mb-0" style="font-weight: bold;">Rosters</h5>
{% endblock breadcrumb %}

{% block content %}

{% for message in messages %}
<p class="text-danger text-center" id="messages">{{message}}</p>
{% endfor %}
<div class="row">
    <div class="col-3">
        <div>
            <div class="form-group">
                <form action="" id="search_form">
                    <!-- <label for="">Search By Center</label> -->
                    <select class="form-control" id="selected_center_id" name="selected_center" onchange="submit_center(this)">
                        <!-- <option value="0">Search By Center</option> -->
                        {% for center in all_centers %}
                        <option {% if center_id == center.id|stringformat:"s" %} selected {% endif %} value="{{center.id}}">{{center.zenoti_data.name}}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="form-group">
            <form action="" id="search_form_2">
                <select class="form-control select2" id="selected_location_id" name="selected_location"
                    onchange="submit_location(this)" multiple="multiple">
                    <option {% if 0|stringformat:"s" in location_id|stringformat:"s" %} selected {% endif %} value="0">All</option>
                    {% for each_location in all_location %}
                    <option {% if each_location.id|stringformat:"s" in location_id|stringformat:"s" %} selected {% endif %} value="{{ each_location.id }}">{{ each_location.location }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    <div class="col-6">
        <div class="row justify-content-end">
            <div class="m-2">
                <button class="btn btn-success" data-toggle="modal" data-target="#add_new_roster_modal">Add New Roster</button>
            </div>
            <div class="m-2">
                <button class="btn btn-primary" data-toggle="modal" data-target="#copy_to_future_date">Copy Rosters to Future Date</button>
            </div>
            <div class="m-2">
                <button class="btn btn-info" onclick="show_today_missingreport_on_popup()">View Missing Rosters</button>
            </div>
        </div>
    </div>
</div>
<!-- <div class="row">
    <div class="col-6">

    </div>
    
</div> -->
<div class="row">
    <div class="page-content container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body p-1">
                        <div id="paginator1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6">
        {% if is_scheduler %}
        <div class="m-2">
            <div class="btn-group">
                <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     Action
                </button>
                <div class="dropdown-menu">
                    <form action="" method="post"> 
                        {% csrf_token %} 
                        <Button class="dropdown-item" type="submit" name="refresh_scheduler">
                            <i class="fas fa-redo"></i> Refresh Scheduler
                        </Button>
                    </form>
                    <Button class="dropdown-item" data-toggle="modal" data-target="#deleteschedulermodal">
                        <i class="fas fa-trash"></i> Delete Scheduler
                    </Button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <div class="row">
                <div class="col">
                    <h4><strong>Employee</strong></h4>
                </div>
                <div class="col">
                    <h4><strong>Status</strong></h4>
                </div>
                <div class="col">
                    <h4><strong>Start Time</strong></h4>
                </div>
                <div class="col">
                    <h4><strong>End Time</strong></h4>
                </div>
            </div>
            {% for scheduler in all_scheduler %}
            <div class="row">
                <div class="col">
                    <p>{{scheduler.employee.user.first_name}} {{scheduler.employee.user.last_name}}&nbsp;&nbsp;
                        {% if scheduler.remark %}
                        <i class="mdi mdi-comment" data-toggle="tooltip" data-placement="top" title="{{scheduler.remark}}"
                        id="comment_{{scheduler.id}}" onclick="button_show_onchange(this)">
                        </i>
                        {% else %}
                        <i class="mdi mdi-comment-outline" id="nocomment_{{scheduler.id}}" onclick="button_show_onchange(this)"></i>
                        {% endif %}
                    </p>
                    <!-- {{scheduler.associated_role.all}} -->
                </div>
                <div class="col">
                    <select class="form-control p-0" name="" id="status_{{scheduler.id}}" onchange="button_show_onchange(this)"
                        {% if scheduler.status == 'Leave Request' or scheduler.status == 'Leave Approved' or scheduler.status == 'Unplanned Leave' or scheduler.status == 'Week Off' %} style="background-color: red; color: white;" {% else %} style="background: transparent;"  {% endif %} >
                        <option {% if scheduler.status == 'Available' %} selected {% endif %} value="Available">Available</option>
                        <option {% if scheduler.status == 'Week Off' %} selected {% endif %} value="Week Off">Week Off</option>
                        <option {% if scheduler.status == 'Leave Request' %} selected {% endif %} disabled value="Leave Request">Leave Request</option>
                        <option {% if scheduler.status == 'Leave Approved' %} selected {% endif %} disabled value="Leave Approved">Leave Approved</option>
                        <option {% if scheduler.status == 'Unplanned Leave' %} selected {% endif %} value="Unplanned Leave">Unplanned       
                             Leave</option>
                        <option {% if scheduler.status == 'Training/Meeting' %} selected {% endif %}    
                            value="Training/Meeting">Training/Meeting</option>
                        <option {% if scheduler.status == 'Floating Resource' %} selected {% endif %} value="Floating Resource">Floating 
                             Resource</option>
                        <option {% if scheduler.status == 'Internal Transfer' %} selected {% endif %} value="Internal Transfer">Internal 
                             Transfer</option>
                        <option {% if scheduler.status == 'Exit' %} selected {% endif %} value="Exit">Exit</option>
                    </select>
                </div>
                <div class="col">
                    <div id="sttimediv_{{scheduler.id}}" {% if scheduler.status == 'Available' %} style="display:block" {% else %} style="display: none;" {% endif %} >
                        <input class="form-contol p-0" type="time" name="" id="starttime_{{scheduler.id}}"
                            value="{{ scheduler.office_start_time|time:'H:i:s' }}" onchange="button_show_onchange(this)"
                            style="background: transparent; border: none;">
                            <!-- {{ scheduler.office_start_time}} -->
                    </div>
                </div>
                <div class="col">
                    <div id="endtimediv_{{scheduler.id}}" {% if scheduler.status == 'Available' %} style="display:block" {% else %} style="display: none;" {% endif %}>
                        <input class="form-contol p-0 timeampm" type="time" name="" id="endtime_{{scheduler.id}}" value="{{ scheduler.office_end_time|time:'H:i:s' }}"
                            onchange="button_show_onchange(this)" style="background: transparent; border: none;">
                    </div>
                </div>
            </div>
            <div id="edit_{{scheduler.id}}" style="display: none;">
                <div class="row m-2">
                    <input type="text" id="remarkk_{{scheduler.id}}" value="{{scheduler.remark|default_if_none:''}}" class="form-control"   placeholder="Enter remark here">
                </div>
                <div class="row d-flex justify-content-center">
                    <div class="row">
                        <Button id="editbtn_{{scheduler.id}}" class="btn btn-success" onclick="edit_scheduler(this)">Update Now</Button>
                        &nbsp;
                        <button id="cancelbtn_{{scheduler.id}}" class="btn btn-danger" onclick="cancel_scheduler_edit(this)">Cancel</button>
                    </div>
                </div>
            </div>
            <br>
            {% endfor %}
        </div>
        {% else %}
        <!-- <h3 class="text-danger">No Data !!</h3> -->
        <form action="" method="post">
            {% csrf_token %}
            <input type="hidden" name="scheduler_create">
            <Button class="btn-sm btn-link btn-info text-white" type="" 
            onclick="this.form.submit(); this.disabled=true; this.innerHTML='Creatingâ€¦'">Create Scheduler</Button>
        </form>
        {% endif %}
    </div>
    <div class="col-6">
        <div id="dp"></div>
    </div>

</div>

<!--add new roster modal  -->
<div class="modal fade" id="add_new_roster_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-info" id="exampleModalLongTitle">Add New Roster
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="roster_form_id">
                    {% csrf_token %}
                    <input type="hidden" name="create_one_roster">
                    <div id="kar_div">
                        <div class="row">
                            <div class="col">
                                <div class="form-group mb-4">
                                    <label class="mr-sm-2" for="inlineFormCustomSelect">Associated KRA</label>
                                    <select class="form-control" name="select_kra" id="select_kra_id" onchange="show_employee_div()">
                                        <option value="">Select</option>
                                        {% for kra in this_center_kra %}
                                        <option value="{{kra.id}}">{{kra.kra}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group mb-4">
                                    <label class="mr-sm-2" for="inlineFormCustomSelect">Location</label>
                                    <select class="form-control" name="select_location" id="select_location_id" 
                                    onchange="show_employee_div()">
                                        <option value="">Select</option>
                                        {% for each_location in all_location %}
                                        <option value="{{each_location.id}}">{{each_location.location}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>  
                        <div class="row justify-content-center">
                            <span class="text-center text-danger" id="kra_and_location_error"></span>
                        </div> 
                    </div>
                    <div id="filterd_div" style="display: none;">
                        <div class="form-group mb-4">
                            <label class="mr-sm-2" for="inlineFormCustomSelect">Employee</label>
                            <select class="form-control" name="filtered_employee" id="filtered_employee">
                                
                            </select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group mb-4">
                                    <label class="mr-sm-2" for="inlineFormCustomSelect">Start Time</label>
                                    <!-- <input type="text" class="form-control" placeholder="password.." name="passcode" id="" required> -->
                                    <input type="time" min="09:00:00" max="23:00:00"  name="start_tm" id="start_tm_id" class="form-control" required>
                                </div>
                            </div>
                            <div class="col" >
                                <div class="form-group mb-4">
                                    <label class="mr-sm-2" for="inlineFormCustomSelect">End Time</label>
                                    <!-- <input type="text" class="form-control" placeholder="password.." name="passcode" id="" required> -->
                                    <input type="time" min="09:00:00" max="23:00:00" class="form-control" name="end_tm" id="end_tm_id" required>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-success" type="" onclick="submit_creat_roster_form(this)" >Add
                                </button>
                        </div>
                    </div>    
                </form>
            </div>
            <!-- <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div> -->
        </div>
    </div>
</div>

<!-- copy to future date modal  -->
<div class="modal fade" id="copy_to_future_date" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Copy to future Date</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="" id="copy_to_futuredate_form">
                    {% csrf_token %}
                    <div class="form-group mb-4">
                        <label class="mr-sm-2" for="inlineFormCustomSelect">From</label>
                        <input type="date" class="form-control" name="future_from" id="futuredate_from_date" required>
                    </div>
                    <div class="form-group mb-4">
                        <label class="mr-sm-2" for="inlineFormCustomSelect">TO</label>
                        <input type="date" class="form-control" name="future_to" id="futuredate_to_date" required>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-success" type="submit" name="copy_roster_to_future">
                           <span>Set Data</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- view missing report modal  -->
<div class="modal fade" id="view_missing_report" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Missing Rosters</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    <h2 class="text-danger text-center" id="error_text"></h2>
                </div>
                <div id="missing_report_date">
                    <div class="row">
                        <div class="col">
                            <div class="">
                                <label>From</label>
                                <input type="date" class="form-control" name="" id="missing_report_from_date" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="">
                                <label>To</label>
                                <input type="date" class="form-control" name="" id="missing_report_to_date" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mt-2">
                                <br>
                                <!-- <label for="">get</label> -->
                                <button class="btn btn-success" type="button" onclick="get_missing_report()">Get Data</button>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div id="final_missing_report" style="display: none;">
                    <!-- <h1>Missing report</h1> -->

                </div>
            </div>
        </div>
    </div>
</div>

<!-- edit roster modal  -->
<div class="modal fade" id="edit_roster_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Roster</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="roster_edit_form">
                    {% csrf_token %}
                    <div class="form-group mb-4" style="display: none;">
                        <label class="mr-sm-2" for="inlineFormCustomSelect">roster pk</label>
                        <input type="text" name="roster_id" id="roster_pk">
                        <!-- <input type="text" class="form-control" placeholder="name.." name="name" id="" required> -->
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">Associated KRA</label>
                                <select class="form-control" name="employee_kra" id="employee_kra_id" onchange="edit_roster_employee_dropdown()">
                                    <option value="">Select</option>
                                    {% for kra in this_center_kra %}
                                    <option value="{{kra.id}}">{{kra.kra}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">Location</label>
                                <select class="form-control" name="employee_location" id="employee_location_id" 
                                onchange="edit_roster_employee_dropdown()">
                                    <option value="">Select</option>
                                    {% for each_location in all_location %}
                                    <option value="{{each_location.id}}">{{each_location.location}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-4">
                        <label class="mr-sm-2" for="inlineFormCustomSelect">Employee</label>
                        <select class="form-control" name="employee_id" id="emp_select">
                            
                        </select>
                        <!-- <input type="text" class="form-control" placeholder="name.." name="name" id="" required> -->
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">Start Time</label>
                                <input type="time" class="form-control" name="start_time" id="str_time" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">End Time</label>
                                <input type="time" class="form-control" name="end_time" id="end_time" required>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-success" name="edit_roster_form" type="submit">Update</button> &nbsp;
                        <button class="btn btn-danger" type="button" onclick="delete_confirmation_show()">Delete</button>
                    </div>
                </form>
            </div>
            <div class="m-4" id="del_confirm" style="display: none;">
                <form action="" method="post">
                    {% csrf_token %}
                    <div class="form-group mb-4" style="display: none;">
                        <label class="mr-sm-2" for="inlineFormCustomSelect">roster pk</label>
                        <input type="text" name="del_id" id="del_pk">
                        <!-- <input type="text" class="form-control" placeholder="name.." name="name" id="" required> -->
                    </div>
                    <h3 class="text-danger">Are you sure, you want to delete this ?</h3>
                    <div class="row justify-content-center">
                        <button type="submit" class="btn btn-primary" name="del_roster">Yes</button> &nbsp;
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- download csv modal  -->
<div class="modal fade" id="download_csv_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Select Date to download CSV File</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'download_csv' %}" id=""> 
                    {% csrf_token %}
                    <input type="hidden" name="csv_type" id="csv_type">
                    <input type="hidden" name="center_id" id="csv_center_id">
                    <div class="row">
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">From</label>
                                <input type="date" class="form-control" name="csv_from" id="csv_from_date" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group mb-4">
                                <label class="mr-sm-2" for="inlineFormCustomSelect">TO</label>
                                <input type="date" class="form-control" name="csv_to" id="csv_to_date" required>
                            </div>
                        </div>
                    </div> 
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-success" type="" name="csv_download" 
                        onclick="this.form.submit(); $('#download_csv_modal').modal('hide');">
                            <span>GET CSV</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- delete scheduler modal  -->
<div class="modal fade" id="deleteschedulermodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete Scheduler</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"> 
                <h5 class="text-center text-danger">Are you sure, you want to delete today's scheduler ?</h5>
            </div>
            <div class="modal-footer">
                <form action="" method="post"> 
                    {% csrf_token %} 
                    <Button class="btn btn-success" type="submit" name="delete_scheduler">
                        Yes 
                    </Button>
                </form>
                <button type="button" class="btn btn-danger" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    var dp = new DayPilot.Scheduler("dp");
    var all_roster = '{{  roster_list|safe }}';
     console.log('list', all_roster) 
    all_roster = JSON.parse(all_roster)
    // console.log('json', all_roster)
    var url = window.location.href;
    var url_param = new URL(url);
    var url_date = url_param.searchParams.get("selected_date");


    // view
    dp.startDate = new DayPilot.Date(url_date);  // or just dp.startDate = "2013-03-25";
    dp.days = 1;

    // dp.timeHeaders = [
    //     { groupBy: "Day" },
    //     { groupBy: "Cell" }
    // ];
    dp.scale = "Hour";

    // below three line is highlighting timeline with white color 
    dp.businessBeginsHour = 9;
    dp.businessEndsHour = 22;
    dp.businessWeekends = true;
    
    // hide time from 12 am to 9 am
    var time_hide_from = url_date+'T09:00:00'
    var time_hide_to = url_date+'T22:00:00'
    dp.onIncludeTimeCell = function (args) {
        // console.log(args.cell.start.value)
            if (args.cell.start.value < time_hide_from || args.cell.start.value > time_hide_to) { // hide time from 12 am to 9 am
                args.cell.visible = false;
            }
    };
    // var startDateTime = '09:00:00'
    // var endDateTime = '22:00:00'
    
    // dp.cellDuration = 30
    // dp.eventDeleteHandling = "Update";
    dp.onEventDelete = args => {
            if (!confirm("Do you really want to delete this event?")){
                args.preventDefault();
            }
        };
        dp.onEventDeleted = args => {
            // console.log('del', args.e.text())
            // API call to delete the event on the server side
            // ...
            dp.message("Deleted");
        };

    dp.treeEnabled = false;

    var kra_kv = {{ center_kra_json|safe }};

    dp.resources = {{ center_kra_list|safe }};
    // dp.resources = [
    //     { name: "RAR", id: "A" },
    //     { name: "HHR", id: "B" },
    //     { name: "SAR", id: "C" },
    //     { name: "CI", id: "D" },
    // ];

    // generate and load events
    for (var i = 0; i < all_roster.length; i++) {
        
        each_roster = all_roster[i]
        var final_resource = kra_kv[each_roster['kra']];
        // console.log(each_roster['name'])

        var e = new DayPilot.Event({
            start: new DayPilot.Date(url_date+"T"+ each_roster['start_time']),
            end: new DayPilot.Date(url_date + "T" + each_roster['end_time']),
            id: DayPilot.guid(),
            
            resource: final_resource,
            text: each_roster['name'],
            bubbleHtml:  ` ${each_roster['name']} <br> ${each_roster['kra']} <br> ${each_roster['start_time']} - ${each_roster['end_time']} <br> <br>  <button class="btn btn-sm btn-link" onclick="edit_roster_data_popup(${each_roster['roster_pk']})"> Edit </button>`,
            toolTip: "my tooltip"

        });
        dp.events.add(e);
    }

    // event creating
    // dp.onTimeRangeSelected = function (args) {
    //     var name = prompt("New event name:", "Event");
    //     dp.clearSelection();
    //     if (!name) return;
    //     var e = new DayPilot.Event({
    //         start: args.start,
    //         end: args.end,
    //         id: DayPilot.guid(),
    //         resource: args.resource,
    //         text: name
    //     });
    //     dp.events.add(e);
    //     dp.message("Created");
    // };

    dp.snapToGrid = false;
    dp.useEventBoxes = "Never";

    // dp.onEventMoving = function (args) {
    //     var offset = args.start.getMinutes() % 5;
    //     if (offset) {
    //         args.start = args.start.addMinutes(-offset);
    //         args.end = args.end.addMinutes(-offset);
    //     }

    //     args.left.enabled = true;
    //     args.left.html = args.start.toString("h:mm tt");
    // };

    dp.cellWidth = 60;

    dp.init();

    dp.scrollTo("2013-03-24T16:00:00");

</script>
<script>
    $(document).ready(function () {
            $('#selected_location_id').select2({
                dropdownAutoWidth: true,
                multiple: true,
                width: '100%',
                height: '30px',
                placeholder: "Select",
                allowClear: true,
                // dropdownParent: $('#extra_data_div')
            });
        });
    // $(document).ready(function () {
    //     let redirect_url = '{{redirect_uri}}';
    //     if (redirect_url.length > 0){

    //         window.location.href = redirect_url
    //     }
    // })

    
    // function open_csv_modal(t){
    //     console.log(t)
    //     var url = window.location.href;
    //     var url_param = new URL(url);
    //     var url_center = url_param.searchParams.get("selected_center");
    //     document.getElementById('csv_type').value = t;
    //     document.getElementById('csv_center_id').value = url_center;
    //     $('#download_csv_modal').modal('show');
    // }

    function submit_creat_roster_form(e) {
            // e.disabled = true;
            var form = document.getElementById('roster_form_id');
            // var submitButton = document.getElementById(e.id);
            var st_time = document.getElementById('start_tm_id').value;
            var end_time = document.getElementById('end_tm_id').value;
            if(st_time < end_time){
                 form.addEventListener('submit', function () {
                    $("cover-spin").show(0);
                    // Disable the submit button
                    e.setAttribute('disabled', 'disabled');
                    // Change the "Submit" text
                    e.innerHTML = 'Please wait...';

                }, false);
            }else{
                alert('Start Time should be less that End TIme');
            }
           
        }

    function show_employee_div(){
        var kra_id = document.getElementById('select_kra_id').value;
        var location_id = document.getElementById('select_location_id').value;
        if(kra_id.length >0 && location_id.length >0){
            document.getElementById('kra_and_location_error').innerHTML = '';
        }else{
            document.getElementById('kra_and_location_error').innerHTML = 'Please Select Both KRA And Location !!';
            return;
        }
        var center_id = document.getElementById('selected_center_id').value;
        var emp_select = document.getElementById('filtered_employee');
       $("#filtered_employee").children().remove();
        var employee = {{ emp_json| safe }}
        console.log(employee)
        for(var i=0; i<employee.length; i++){
            var each_employee = employee[i];
            for(var a=0; a<each_employee['associated_kra'].length; a++){
                var each_kra = each_employee['associated_kra'][a];
                for (var b = 0; b < each_employee['associated_location'].length; b++) {
                    var each_location = each_employee['associated_location'][b];
                    if (location_id == each_location && kra_id == each_kra) {
                        var opt = document.createElement('option');
                        opt.value = each_employee['id'];
                        opt.innerHTML = each_employee['name'];
                        emp_select.appendChild(opt);
                    };
                };
            };
        };
        document.getElementById('filterd_div').style.display = 'block';
    }

    function show_today_missingreport_on_popup(){
        var url = window.location.href;
        var url_param = new URL(url);
        var url_date = url_param.searchParams.get('selected_date');
        var today = moment(new Date()).format("YYYY-MM-DD")
        var from = document.getElementById('missing_report_from_date').value = url_date;
        var to = document.getElementById('missing_report_to_date').value = url_date;
        console.log(from, to )
        get_missing_report();
        $('#view_missing_report').modal('show');

    }

    function delete_confirmation_show() {
            var del_id = document.getElementById('del_pk');
            var roster_pk = document.getElementById('roster_pk').value;
            del_id.value = roster_pk; 
            document.getElementById("del_confirm").style.display = 'block';
        }

    function edit_roster_employee_dropdown() {
        var kra_id = document.getElementById('employee_kra_id').value;
        var location_id = document.getElementById('employee_location_id').value;
        var center_id = document.getElementById('selected_center_id').value;
        var emp_select = document.getElementById('emp_select');
        $("#emp_select").children().remove()
        var employee = {{ emp_json| safe }}
        console.log(employee)
        for (var i = 0; i < employee.length; i++) {
            var each_employee = employee[i]
            console.log('kra', typeof (kra_id), each_employee['associated_kra'])
            for(var a = 0; a < each_employee['associated_kra'].length; a++) {
                var each_kra = each_employee['associated_kra'][a];
                for (var b = 0; b < each_employee['associated_location'].length; b++) {
                    var each_location = each_employee['associated_location'][b];
                    if (location_id == each_location && kra_id == each_kra) {
                        var opt = document.createElement('option');
                        opt.value = each_employee['id'];
                        opt.innerHTML = each_employee['name'];
                        emp_select.appendChild(opt);
                    };
                };
            };
        }
    }

    function edit_roster_data_popup(t){
        // console.log('id', t)
        $('#cover-spin').show(0);
        document.getElementById("del_confirm").style.display = 'none';
        var employee = document.getElementById('emp_select');
        var selected_kra = document.getElementById('employee_kra_id');
        var selected_location = document.getElementById('employee_location_id');
        var st_time = document.getElementById('str_time');
        var end_time = document.getElementById('end_time');
        var roster_pk = document.getElementById('roster_pk'); 
        var roster_id = t;
        fetch("/edit_employee_roster/", {
            method: "POST",
            body: JSON.stringify({
                data_obj: roster_id,
            }),
            // Adding headers to the request
            headers: {
                "Content-type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
        })
            .then((response) => {
                // console.log(response);
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                return response.json();
            })
            .then((data) => {
                // console.log("Success: ", data);
                var roster_data = data.roster_json
                var final_data = roster_data[0]['fields'];
                if (data.msg == 'success') {
                    // document.getElementById("edit_" + scheduler_id).style.display = 'none';
                    // console.log('d', final_data)
                    roster_pk.value = roster_id;
                    // employee.value = final_data['employee'];
                    edit_roster_employee_dropdown();
                    $("#emp_select").children(`[value="${final_data['employee']}"]`).prop("selected", true).trigger("change");
                    $("#employee_location_id").children(`[value="${final_data['associated_location']}"]`).prop("selected", true).trigger("change");
                    $("#employee_kra_id").children(`[value="${final_data['associated_kra']}"]`).prop("selected", true).trigger("change");
                    st_time.value = final_data['office_start_time'];
                    end_time.value = final_data['office_end_time'];
                    $('#edit_roster_modal').modal('show');
                    $('#cover-spin').hide(0);
                }
                else {
                    alert('Something went wrong, Please try again after refreshing the page')
                    $('#cover-spin').hide(0);
                }
            });


    }
    

    function button_show_onchange(t){
        var btn_id = t.id.split('_')[1];
        document.getElementById("edit_"+btn_id).style.display = 'block';
        if (t.value == 'Available'){
            document.getElementById('sttimediv_'+btn_id).style.display= 'block';
            document.getElementById('endtimediv_' + btn_id).style.display = 'block';
        }

    }
    function cancel_scheduler_edit(t){
        var cancel_btn_id = t.id.split('_')[1];
        document.getElementById("edit_"+cancel_btn_id).style.display = 'none';
    }

    function edit_scheduler(t) {
            $('#cover-spin').show(0);
            var scheduler_id = t.id.split('_')[1];
            // console.log(scheduler_id)
            var from_time = document.getElementById('starttime_'+scheduler_id).value;
            var to_time = document.getElementById('endtime_'+scheduler_id).value;
            var status = document.getElementById('status_'+scheduler_id).value;
            var remark = document.getElementById('remarkk_'+scheduler_id).value;
            // console.log(scheduler_id, from_time, to_time, status)
            var sending_data = [];
            try {
                scheduler_query = {
                    scheduler:scheduler_id,
                    from_tm: from_time,
                    to_tm: to_time,
                    status: status,
                    remark: remark,
                }
                if (scheduler_query.from_tm.length > 0 && scheduler_query.to_tm.length > 0 && scheduler_query.status.length > 0 && 
                scheduler_query.scheduler.length > 0) {
                    // console.log('id', scheduler_query.from_dt, scheduler_query.to_dt, scheduler_query.center);
                    sending_data.push(scheduler_query);
                } else { alert('All fields are compulsary'); }

            } catch (e) { }
            if(status == 'Available'){
                if (from_time < to_time) {
                    fetch("/edit_employee_scheduler/", {
                        method: "POST",
                        body: JSON.stringify({
                            data_obj: sending_data,
                        }),
                        // Adding headers to the request
                        headers: {
                            "Content-type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    })
                        .then((response) => {
                            // console.log(response);
                            if (response.redirected) {
                                window.location.href = response.url;
                                return;
                            }
                            return response.json();
                        })
                        .then((data) => {
                            // console.log("Success: ", data);
                            if (data.msg == 'success') {
                                document.getElementById("edit_" + scheduler_id).style.display = 'none';
                                if (status == 'Week Off' || status == 'Leave Request' || status == 'Leave Approved' || status == 'Unplanned Leave') {
                                    document.getElementById('status_' + scheduler_id).style.background = 'red';
                                    document.getElementById('status_' + scheduler_id).style.color = 'white';
                                } else {
                                    document.getElementById('status_' + scheduler_id).style.background = 'transparent';
                                    document.getElementById('status_' + scheduler_id).style.color = 'black';
                                }
                                // $('#cover-spin').hide(0);
                                location.reload();
                            }
                            else {
                                alert('Something went wrong, Please try again after refreshing the page')
                                $('#cover-spin').hide(0);
                            }
                        });
                } else {
                    $('#cover-spin').hide(0);
                    alert('Start Time should be less than End Time')
                }      

            }else{
                fetch("/edit_employee_scheduler/", {
                    method: "POST",
                    body: JSON.stringify({
                        data_obj: sending_data,
                    }),
                    // Adding headers to the request
                    headers: {
                        "Content-type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                })
                    .then((response) => {
                        // console.log(response);
                        if (response.redirected) {
                            window.location.href = response.url;
                            return;
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // console.log("Success: ", data);
                        if (data.msg == 'success') {
                            document.getElementById("edit_" + scheduler_id).style.display = 'none';
                            if (status == 'Week Off' || status == 'Leave Request' || status == 'Leave Approved' || status == 'Unplanned Leave') {
                                document.getElementById('status_' + scheduler_id).style.background = 'red';
                                document.getElementById('status_' + scheduler_id).style.color = 'white';
                            } else {
                                document.getElementById('status_' + scheduler_id).style.background = 'transparent';
                                document.getElementById('status_' + scheduler_id).style.color = 'black';
                            }
                            // $('#cover-spin').hide(0);
                            location.reload();
                        }
                        else {
                            alert('Something went wrong, Please try again after refreshing the page')
                            $('#cover-spin').hide(0);
                        }
                    });
            }
            
    }

    function submit_center(t){
        // $('#cover-spin').show(0);
        var url = window.location.href;
        var url_param = new URL(url);
        var url_center = url_param.searchParams.get('selected_center');
        var url_section = url_param.searchParams.getAll('selected_location');
        var url_date = url_param.searchParams.get('selected_date');
        var val_id = t.value;
        // console.log('id', t.value)
      
        // url = '/roster_dashboard/?selected_center='+val_id+'&selected_section='+url_section+'&selected_date='+url_date

        url = '/roster_dashboard/?selected_center=' + val_id +
            (url_section.length > 0 ? '&selected_location=' + url_section.join('&selected_location=') : '') +
            '&selected_date=' + url_date;
        window.location.href = url;
            // location.reload()
       
    }




    function submit_location(t){
        // $('#cover-spin').show(0);
        var url = window.location.href;
        var url_param = new URL(url);
        var url_center = url_param.searchParams.get('selected_center');
        var url_section =  [...new Set(url_param.searchParams.getAll('selected_location'))];
        var url_date = url_param.searchParams.get('selected_date');
        var val_id = $('#'+t.id).val();
        url = '/roster_dashboard/?selected_center='+url_center+'&selected_location='+ val_id.join('&selected_location=')+'&selected_date='+url_date
        // url = '/roster_dashboard/?selected_center=' + url_center +
        //     (url_section.length > 0 ? '&selected_section=' + url_section.join('&selected_section=') : '') +
        //     '&selected_date=' + url_date;
        // console.log(url)
        window.location.href = url;
    }
    
    function get_missing_report() {
            $('#cover-spin').show(0);
            var from_date = document.getElementById('missing_report_from_date').value;
            var to_date = document.getElementById('missing_report_to_date').value;
            var center_id = document.getElementById('selected_center_id').value;
            var location_id = document.getElementById('selected_location_id').value;
            var sending_data = [];
            try{
                roster_query = {
                    from_dt: from_date,
                    to_dt: to_date,
                    center: center_id,
                    location: location_id,
                }
                if (roster_query.from_dt.length > 0 && roster_query.to_dt.length > 0 && roster_query.center.length > 0 && roster_query.location.length > 0) {
                    // console.log('id', roster_query.from_dt, roster_query.to_dt, roster_query.center );
                    sending_data.push(roster_query);
                } else { document.getElementById('error_text').innerHTML = 'All inputs are compulsary !!'; $('#cover-spin').hide(0); }
    
            }catch (e) {}

            fetch("/get_missing_report/", {
                method: "POST",
                body: JSON.stringify({
                    data_obj: sending_data,
                }),
                // Adding headers to the request
                headers: {
                    "Content-type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
            })
                .then((response) => {
                    // console.log(response);
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    return response.json();
                })
                .then((data) => {
                    // console.log("Success: ", data);
                    if (data.msg == 'success') {
                        var missing_report = data.roster_data
                        var missing_report_div = document.getElementById('final_missing_report');
                            missing_report_div.innerHTML = '';
                        for (let i=0; i < missing_report.length; i++ ){
                            missing_report_div.innerHTML += "<p>"+ missing_report[i] + "</p>";
                        }
                        // document.getElementById('missing_report_date').style.display = 'none';
                        missing_report_div.style.display = 'block';
                        $('#cover-spin').hide(0);
                    }
                    else {
                        document.getElementById('error_text').innerHTML = "Something went Wrong please refresh the page";
                        $('#cover-spin').hide(0);
                    }
                });
        }

    
</script>
{% endblock %}